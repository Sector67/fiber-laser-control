<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">ol.lst-kix_b9oyfh079ol-5.start{counter-reset:lst-ctn-kix_b9oyfh079ol-5 0}.lst-kix_b9oyfh079ol-4>li{counter-increment:lst-ctn-kix_b9oyfh079ol-4}.lst-kix_b9oyfh079ol-7>li{counter-increment:lst-ctn-kix_b9oyfh079ol-7}ol.lst-kix_b9oyfh079ol-7.start{counter-reset:lst-ctn-kix_b9oyfh079ol-7 0}.lst-kix_b9oyfh079ol-8>li:before{content:"" counter(lst-ctn-kix_b9oyfh079ol-8,lower-roman) ". "}.lst-kix_b9oyfh079ol-7>li:before{content:"" counter(lst-ctn-kix_b9oyfh079ol-7,lower-latin) ". "}.lst-kix_b9oyfh079ol-2>li{counter-increment:lst-ctn-kix_b9oyfh079ol-2}.lst-kix_b9oyfh079ol-5>li:before{content:"(" counter(lst-ctn-kix_b9oyfh079ol-5,lower-roman) ") "}ol.lst-kix_b9oyfh079ol-2.start{counter-reset:lst-ctn-kix_b9oyfh079ol-2 0}.lst-kix_b9oyfh079ol-4>li:before{content:"(" counter(lst-ctn-kix_b9oyfh079ol-4,lower-latin) ") "}.lst-kix_b9oyfh079ol-6>li:before{content:"" counter(lst-ctn-kix_b9oyfh079ol-6,decimal) ". "}ol.lst-kix_b9oyfh079ol-3.start{counter-reset:lst-ctn-kix_b9oyfh079ol-3 0}ol.lst-kix_b9oyfh079ol-8.start{counter-reset:lst-ctn-kix_b9oyfh079ol-8 0}ol.lst-kix_b9oyfh079ol-1{list-style-type:none}ol.lst-kix_b9oyfh079ol-2{list-style-type:none}.lst-kix_b9oyfh079ol-6>li{counter-increment:lst-ctn-kix_b9oyfh079ol-6}.lst-kix_b9oyfh079ol-2>li:before{content:"" counter(lst-ctn-kix_b9oyfh079ol-2,lower-roman) ") "}ol.lst-kix_b9oyfh079ol-0{list-style-type:none}ol.lst-kix_b9oyfh079ol-0.start{counter-reset:lst-ctn-kix_b9oyfh079ol-0 0}.lst-kix_b9oyfh079ol-3>li:before{content:"(" counter(lst-ctn-kix_b9oyfh079ol-3,decimal) ") "}ol.lst-kix_b9oyfh079ol-5{list-style-type:none}ol.lst-kix_b9oyfh079ol-6{list-style-type:none}ol.lst-kix_b9oyfh079ol-3{list-style-type:none}ol.lst-kix_b9oyfh079ol-4{list-style-type:none}ol.lst-kix_b9oyfh079ol-7{list-style-type:none}ol.lst-kix_b9oyfh079ol-8{list-style-type:none}.lst-kix_b9oyfh079ol-0>li{counter-increment:lst-ctn-kix_b9oyfh079ol-0}ol.lst-kix_b9oyfh079ol-6.start{counter-reset:lst-ctn-kix_b9oyfh079ol-6 0}.lst-kix_b9oyfh079ol-3>li{counter-increment:lst-ctn-kix_b9oyfh079ol-3}.lst-kix_b9oyfh079ol-1>li:before{content:"" counter(lst-ctn-kix_b9oyfh079ol-1,lower-latin) ") "}.lst-kix_b9oyfh079ol-0>li:before{content:"" counter(lst-ctn-kix_b9oyfh079ol-0,decimal) ") "}li.li-bullet-0:before{margin-left:-18pt;white-space:nowrap;display:inline-block;min-width:18pt}.lst-kix_b9oyfh079ol-5>li{counter-increment:lst-ctn-kix_b9oyfh079ol-5}.lst-kix_b9oyfh079ol-8>li{counter-increment:lst-ctn-kix_b9oyfh079ol-8}ol.lst-kix_b9oyfh079ol-4.start{counter-reset:lst-ctn-kix_b9oyfh079ol-4 0}ol.lst-kix_b9oyfh079ol-1.start{counter-reset:lst-ctn-kix_b9oyfh079ol-1 0}.lst-kix_b9oyfh079ol-1>li{counter-increment:lst-ctn-kix_b9oyfh079ol-1}ol{margin:0;padding:0}table td,table th{padding:0}.c14{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:65.2pt;border-top-color:#000000;border-bottom-style:solid}.c20{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:120.8pt;border-top-color:#000000;border-bottom-style:solid}.c3{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:46.5pt;border-top-color:#000000;border-bottom-style:solid}.c22{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:356.2pt;border-top-color:#000000;border-bottom-style:solid}.c12{border-right-style:solid;padding:5pt 5pt 5pt 5pt;border-bottom-color:#000000;border-top-width:1pt;border-right-width:1pt;border-left-color:#000000;vertical-align:top;border-right-color:#000000;border-left-width:1pt;border-top-style:solid;border-left-style:solid;border-bottom-width:1pt;width:75pt;border-top-color:#000000;border-bottom-style:solid}.c15{background-color:#ffffff;color:#333333;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:10pt;font-family:"Arial";font-style:normal}.c5{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c19{color:#000000;font-weight:700;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:normal}.c1{margin-left:36pt;padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c13{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:16pt;font-family:"Arial";font-style:normal}.c10{color:#434343;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:14pt;font-family:"Arial";font-style:normal}.c6{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:11pt;font-family:"Arial";font-style:italic}.c4{padding-top:16pt;padding-bottom:4pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c26{padding-top:20pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c16{color:#000000;font-weight:400;text-decoration:none;vertical-align:baseline;font-size:20pt;font-family:"Arial";font-style:normal}.c18{padding-top:18pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.c11{padding-top:0pt;padding-bottom:0pt;line-height:1.0;orphans:2;widows:2;text-align:left}.c2{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c0{text-decoration-skip-ink:none;-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline}.c8{border-spacing:0;border-collapse:collapse;margin-right:auto}.c24{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c23{padding:0;margin:0}.c17{color:inherit;text-decoration:inherit}.c7{height:11pt}.c25{height:23pt}.c9{height:0pt}.c21{padding-left:0pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c24 doc-content"><h1 class="c26" id="h.5ksmcsu9h5pr"><span class="c16">Building a control system for a 500W Raycus fiber laser using LinuxCNC and QtPlasmaC</span></h1><h2 class="c18" id="h.egemm7h24e3l"><span class="c13">Introduction</span></h2><p class="c2"><span class="c5">This document describes a project at Madison, WI USA-based hackerspace Sector67 to create a control system for a Raycus 500 Watt fiber laser cutter using LinuxCNC and QtPlasmaC. This project was basically a proof of concept to work out what would be needed to operationalize a LinuxCNC-controlled fiber laser system. The laser source and head were donated to the space and came to us in an unproven state. There were several challenges that needed to be overcome, but in the end we were able to build a solidly functional fiber laser cutting system. </span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span class="c5">Many thanks to the Sector67 members that contributed to this project, of course Chris Meyer but also Dave Franchino, Ken Delpapa and many others.</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span class="c5">Also many thanks to the dedicated volunteers on the LinuxCNC forums who give of their time freely to foster not only an amazing open source project but also a fantastic open source community. In particular for this project Phillip Carter (phillc54), Tom Berisha (tommylight), Peter Wallace (PCW) and Rod Webster (rodw) were very helpful but there are many others. This project stands on the shoulders of those giants. A lot of this article is summarizing and re-hashing conversations that happened on the LinuxCNC forums.</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span>It is important to mention that fiber lasers will absolutely make you blind in an instant. You must be extremely careful when experimenting with or operating a fiber laser. We surrounded ours with an enclosure and added two cameras to enable operator feedback without needing to put human eyes at risk. The information here is provided to capture our process. </span><span class="c19">If you implement a fiber laser you are proceeding at your own risk and should educate yourself about the real risks of these devices.</span></p><p class="c2"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 413.50px; height: 397.21px;"><img alt="" src="images/image2.jpg" style="width: 413.50px; height: 397.21px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c2"><span class="c6">&nbsp;The laser cutter</span></p><h2 class="c18" id="h.tu4rf0uxzdj"><span class="c13">The hardware </span></h2><h3 class="c4" id="h.nwwqa3ma950m"><span class="c10">The laser source</span></h3><p class="c2"><span class="c5">The laser source for this project was a 500 Watt Raycus C500 &ldquo;Continuous Wave Fiber Laser&rdquo;. This laser source has various methods of controlling laser power. For this project we are running it in &ldquo;AD&rdquo; mode supplying a 0-10V analog voltage for the laser power, a 24VDC for laser modulation, and 24VDC for laser enable. There is an RS232 serial connection on the device, but we were never able to get more than very rudimentary information from the serial connection. </span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span class="c5">One important note is that if the LinuxCNC control system is sending a &ldquo;laser enable&rdquo; +24VDC signal when the laser source is powered up the laser source will enter a fault mode. In our configuration this signal is enabled when the &ldquo;machine on&rdquo; state is entered. We are currently resolving this by powering the laser source first and then enabling the machine. In QtPlasmaC this is the &ldquo;POWER&rdquo; button. The laser does send a +24VDC &ldquo;laser ready&rdquo; signal on the DB25 connector, and we could in theory use this to prevent entering the &ldquo;machine on&rdquo; state unless the laser is powered. However, we currently do a lot of machine testing without the laser on at all, so for now we are just manually working around this with awareness and the specific power on procedure.</span></p><h3 class="c4" id="h.byzvgv25oa8g"><span class="c10">The laser head</span></h3><p class="c2"><span class="c5">Our laser head is a &ldquo;WSX-MN15&rdquo; model. This manual focus laser head came to us with what should have been a standalone close-loop capacitive height sensor and control board. We could never get that to work properly, which was not a significant problem because from the beginning we wanted to get closed-loop height control controlled by LinuxCNC. So we ended up gutting the on-head capacitive sense and Z height controls and routing the new sensor (described below), home and float sensors, and Z stepper control back to the main control box.</span></p><p class="c2"><span class="c5">One note is that in addition to everything we stripped off the head, we adapted the air assist to take a &frac14;&rdquo; &ldquo;push to connect&rdquo; fitting. The threads on the head were G1/8 (BSPP) straight threads, not NPT. It is important to get that right or you may damage the threads on the head and not have an air tight fitting.</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 430.50px; height: 403.59px;"><img alt="" src="images/image8.jpg" style="width: 430.50px; height: 403.59px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c2"><span class="c6">The laser head</span></p><h3 class="c4" id="h.cox3mwakibvv"><span class="c10">The capacitive sensor</span></h3><p class="c2"><span class="c5">We used a BCL-AMP capacitive sensor for laser head height sensing. These capacitive sensors are typically used for height sensing in fiber laser cutting systems. The sensors come potted in an aluminum case with a small coax connector to connect to the laser head and a GX16 4-pin circular aviation connector to drive the device. These sensors look like this:</span></p><p class="c2"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 298.50px; height: 244.92px;"><img alt="" src="images/image3.png" style="width: 298.50px; height: 244.92px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c2"><span class="c6">The capacitive amp</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span>There are a number of capacitive sensors with this same basic form factor. We used a &ldquo;BCL-AMP Amplifier Preamplifier Sensor For Friendess BCS100 Height Controller FSCUT1000 FSCUT2000 System&rdquo; amp. As of the time this article was written, this amps is available for $52.50 US at </span><span class="c0"><a class="c17" href="https://www.google.com/url?q=http://www.aliexpress.us/item/3256804585924423.html&amp;sa=D&amp;source=editors&amp;ust=1715124500153944&amp;usg=AOvVaw0S5N8zF_6rZxcwp-GCfg2O">www.aliexpress.us/item/3256804585924423.html</a></span><span class="c5">.</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span class="c5">Interfacing the amp to LinuxCNC is described in sections below.</span></p><h3 class="c4" id="h.9d49lpavn3gk"><span class="c10">The XY table</span></h3><p class="c2"><span class="c5">The table itself is not really notable. As a prototype platform it has a working area of about 2&rsquo;x2&rsquo; with stepper motor control. It&rsquo;s not especially fast or rigid unfortunately. There are plenty of other resources for how to get that working with LinuxCNC, so I won&rsquo;t cover it in too much depth here.</span></p><h3 class="c4" id="h.czhdib27p1ij"><span class="c10">Gas assist</span></h3><p class="c2"><span class="c5">We used a simple 24VDC gas solenoid to control the gas flow. We also implemented a low pressure bypass so that when gas is on there is always some amount of air flowing out of the laser head. This should hopefully prevent any contaminants from getting to the lens when the machine is running.</span></p><h2 class="c18" id="h.qh02qdjf93bg"><span class="c13">The electronics of the control system</span></h2><h3 class="c4" id="h.4rn8y4v7y2my"><span class="c10">Mesa card</span></h3><p class="c2"><span class="c5">We&rsquo;re using a Mesa 7i92TF Anything I/O Ethernet card for I/O. We&rsquo;re using the G540x2 firmware. We&rsquo;re using three stepgens for XYZ, one encoder for capacitive sensor input, one PWMgen for 0-10V analog output, and a bunch of I/O. We&rsquo;re using both the DB25 and 26 pin headers. One advantage of cards like the 7i92 is that you can select via jumper independently if you want the P1 or P2 to be pullup or pulldown. We set the P1 jumper to pulldown which simplified the startup state and the logic and wiring of some components.</span></p><h3 class="c4" id="h.csm7reok17cn"><span class="c10">Capacitive sensor interface</span></h3><p class="c2"><span class="c5">The functionality of the GX16 4-pin circular aviation connector on the amp seems to be one of the great mysteries of the Internet. As far as we have been able to find, no data sheet or manual for the amp exists, and the circuit diagrams provided by machine integrators do not provide enough detail to determine how to interface with the amp. As a result, we&rsquo;ve had to reverse engineer the device to determine how to properly interface with it. The results of that experimentation have led us to the following pin functions, with the pins numbered per the GX16 connector spec:</span></p><p class="c2 c7"><span class="c5"></span></p><a id="t.0128f74e79b8c43ee2ce0ee8a1429937283ba753"></a><a id="t.0"></a><table class="c8"><tr class="c9"><td class="c3" colspan="1" rowspan="1"><p class="c11"><span class="c5">Pin</span></p></td><td class="c14" colspan="1" rowspan="1"><p class="c11"><span class="c5">Function</span></p></td><td class="c22" colspan="1" rowspan="1"><p class="c11"><span class="c5">Notes</span></p></td></tr><tr class="c9"><td class="c3" colspan="1" rowspan="1"><p class="c11"><span class="c5">1</span></p></td><td class="c14" colspan="1" rowspan="1"><p class="c11"><span class="c5">+5V</span></p></td><td class="c22" colspan="1" rowspan="1"><p class="c11"><span class="c5">DC5V DC supplied to the amp</span></p></td></tr><tr class="c9"><td class="c3" colspan="1" rowspan="1"><p class="c11"><span class="c5">2</span></p></td><td class="c14" colspan="1" rowspan="1"><p class="c11"><span class="c5">Signal out</span></p></td><td class="c22" colspan="1" rowspan="1"><p class="c11"><span class="c5">A ~5V variable frequency pulse train output</span></p></td></tr><tr class="c9"><td class="c3" colspan="1" rowspan="1"><p class="c11"><span class="c5">3</span></p></td><td class="c14" colspan="1" rowspan="1"><p class="c11"><span class="c5">GND</span></p></td><td class="c22" colspan="1" rowspan="1"><p class="c11"><span class="c5">0V DC supplied to the amp</span></p></td></tr><tr class="c9"><td class="c3" colspan="1" rowspan="1"><p class="c11"><span class="c5">4</span></p></td><td class="c14" colspan="1" rowspan="1"><p class="c11"><span class="c5">SHIELD</span></p></td><td class="c22" colspan="1" rowspan="1"><p class="c11"><span class="c5">This is the one pin that you can find conclusively documented on the Internet. This pin should be tied to the cable shield. Internal to the amp, pins 3 and 4 are tied together to the ground plane, with pin 3 going through an RF choke inside the device.</span></p></td></tr></table><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span class="c5">With this hookup and some capacitive input on the small coax connector you can observe a variable-frequency output on pin 2 of the amp. The variable frequency output of the amp is unfortunately not a very clean signal. To clean up this signal we used a SN74HC14N schmitt trigger:</span></p><p class="c2 c7"><span class="c15"></span></p><p class="c2"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 261.50px; height: 187.32px;"><img alt="" src="images/image5.png" style="width: 261.50px; height: 187.32px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c2"><span class="c6">Schmitt trigger pinout</span></p><p class="c2 c7"><span class="c15"></span></p><p class="c2"><span class="c5">which creates a much cleaner square wave. VCC is wired to +5V and per the data sheet all of the inputs except for one are tied to ground so they don&rsquo;t float. The output of pin 2 on the amp is wired to one of the trigger inputs, and the output of the trigger is wired to our Mesa 5i25 hostmot2 encoder A-phase input. The SN74HC14N also provides a modest level of signal isolation.</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span class="c5">Capacitive frequency response</span></p><p class="c2"><span class="c5">The following values were measured in a bench setup using a variable capacitor (a radio tuning capacitor wired directly to the amp inputs):</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2 c7"><span class="c5"></span></p><a id="t.643b0621fcbd6d9d6e0c0a5c7feb3bf863e4ec7b"></a><a id="t.1"></a><table class="c8"><tr class="c9"><td class="c12" colspan="1" rowspan="1"><p class="c11"><span class="c5">Capacitance</span></p></td><td class="c20" colspan="1" rowspan="1"><p class="c11"><span class="c5">Frequency</span></p></td></tr><tr class="c9"><td class="c12" colspan="1" rowspan="1"><p class="c11"><span>85pF</span></p></td><td class="c20" colspan="1" rowspan="1"><p class="c11"><span class="c5">2.50MHz</span></p></td></tr><tr class="c25"><td class="c12" colspan="1" rowspan="1"><p class="c11"><span class="c5">123pF</span></p></td><td class="c20" colspan="1" rowspan="1"><p class="c11"><span class="c5">2.00MHz</span></p></td></tr><tr class="c9"><td class="c12" colspan="1" rowspan="1"><p class="c11"><span class="c5">166pF</span></p></td><td class="c20" colspan="1" rowspan="1"><p class="c11"><span class="c5">1.67MHz</span></p></td></tr><tr class="c9"><td class="c12" colspan="1" rowspan="1"><p class="c11"><span class="c5">210pF</span></p></td><td class="c20" colspan="1" rowspan="1"><p class="c11"><span class="c5">1.54MHz</span></p></td></tr><tr class="c9"><td class="c12" colspan="1" rowspan="1"><p class="c11"><span class="c5">233pF</span></p></td><td class="c20" colspan="1" rowspan="1"><p class="c11"><span class="c5">1.44MHz</span></p></td></tr></table><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span class="c5">The response is not linear. The closer the metal is to the laser head (the higher the capacitance), the lower the frequency output is. When the head touches the material, the output frequency drops significantly.</span></p><h3 class="c4" id="h.66xb4ks04w4v"><span class="c10">0-10V laser power interface</span></h3><p class="c2"><span>For the 0-10V analog laser power signal we used a frequency to voltage converter from Amazon (</span><span class="c0"><a class="c17" href="https://www.google.com/url?q=https://www.amazon.com/gp/product/B091B6LGXB&amp;sa=D&amp;source=editors&amp;ust=1715124500160115&amp;usg=AOvVaw12sjU0T7mIeGRsbTJ9-pQY">https://www.amazon.com/gp/product/B091B6LGXB</a></span><span class="c5">). This module provides 1-3KHZ 0-10V PWM conversion and basically worked seamlessly with the Mesa PWMgen. Some calibration using the on-board potentiometer was required, and it was not exactly linear, but close enough for our purposes.</span></p><p class="c2"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 258.50px; height: 258.50px;"><img alt="" src="images/image7.png" style="width: 258.50px; height: 258.50px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c2"><span class="c6">The PWM to 0-10VDC converter board </span></p><h3 class="c4" id="h.ni6k43olbf8"><span class="c10">Laser modulation interface</span></h3><p class="c2"><span>Although we are using the laser source&rsquo;s &ldquo;AD&rdquo; mode and sending power via a 0-10V analog signal, we wanted to keep the option to use a fast modulation signal if needed. For that we used a MOSFET board from Amazon (</span><span class="c0"><a class="c17" href="https://www.google.com/url?q=https://www.amazon.com/gp/product/B07NWD8W26&amp;sa=D&amp;source=editors&amp;ust=1715124500160490&amp;usg=AOvVaw3_vWFugVoPFEajZoIoRrf0">https://www.amazon.com/gp/product/B07NWD8W26</a></span><span class="c5">) that provided &nbsp;0-20KHz PWM switching if we needed it. We are currently using it basically as a relay, but we wanted a very low delay when enabling the laser, and this board provides that.</span></p><p class="c2"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 270.63px; height: 168.71px;"><img alt="" src="images/image4.png" style="width: 270.63px; height: 168.71px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c2"><span class="c6">The MOSFET board we used</span></p><p class="c2 c7"><span class="c5"></span></p><h3 class="c4" id="h.x2idnp3le4zr"><span class="c10">The light tree</span></h3><p class="c2"><span class="c5">We had some scrapped equipment with a green/orange/red light tree similar to the one pictured below.</span></p><p class="c2"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 185.50px; height: 185.50px;"><img alt="" src="images/image9.png" style="width: 185.50px; height: 185.50px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c2"><span class="c6">A light tree similar to the one we used</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span>We wanted to use that to make it clear when the laser was powered, when it could fire at any time, and when it was firing (or running a program at least). The light tree is powered by 24VDC. The green light is tied straight to the 24V power supply and lights any time the machine is powered on. The orange and red lights are controlled by a 5VDC relay board from Amazon (</span><span class="c0"><a class="c17" href="https://www.google.com/url?q=https://www.amazon.com/gp/product/B08PP8HXVD&amp;sa=D&amp;source=editors&amp;ust=1715124500161105&amp;usg=AOvVaw1IB8aWRmVREKHiflXtO8P0">https://www.amazon.com/gp/product/B08PP8HXVD</a></span><span class="c5">) pictured below.</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 254.93px; height: 254.93px;"><img alt="" src="images/image6.png" style="width: 254.93px; height: 254.93px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c2"><span class="c6">The relay board we used</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span class="c5">One advantage of this board is that each relay can be configured to be active high or active low by a jumper. We didn&rsquo;t end up using this because one Mesa connector was configured to be pullup and one was configured to be pulldown and we could pick and choose our I/O. </span></p><h3 class="c4" id="h.savg1cssh6db"><span class="c10">The laser enable signal</span></h3><p class="c2"><span class="c5">The laser enable signal is also 24VDC and controlled by one of the relays on the relay board.</span></p><h3 class="c4" id="h.z08dj8315usq"><span class="c10">Other I/O</span></h3><p class="c2"><span class="c5">We had other &ldquo;standard CNC&rdquo; I/O like home switches, estop, and a float switch. I won&rsquo;t go into detail on those in this article as there are a lot of other places where those are discussed in depth.</span></p><h2 class="c18" id="h.wnl22mtl6gm3"><span class="c13">The software configuration</span></h2><h3 class="c4" id="h.ymg1kd5rwzey"><span class="c10">LinuxCNC</span></h3><p class="c2"><span class="c5">We started with LinuxCNC 2.9.2 installed via live CD.</span></p><h3 class="c4" id="h.h0tjb3qaviwp"><span class="c10">PNCConf</span></h3><p class="c2"><span class="c5">We used pncconf for nearly all of our configuration. We applied some configuration customizations after using pncconf. We automated these (described below) so that we could keep the ability to use pncconf to maintain and update the configuration when needed.</span></p><h3 class="c4" id="h.bdo5a8id7fln"><span class="c10">Post-pncconf fixes</span></h3><p class="c2"><span>We want to maintain the ability to update and regenerate the machine configuration using pncconf, but pncconf does not handle every type of customization. So we&rsquo;ve created a shell script with the Linux sed tool to fix the generated configuration. You can find the entire script at </span><span class="c0"><a class="c17" href="https://www.google.com/url?q=https://github.com/Sector67/fiber-laser-control/blob/main/config/fix-pncconf-config.sh&amp;sa=D&amp;source=editors&amp;ust=1715124500162312&amp;usg=AOvVaw3i2KMl8zjt7SiKNwBfFxkV">https://github.com/Sector67/fiber-laser-control/blob/main/config/fix-pncconf-config.sh</a></span><span class="c5">. That script includes &ldquo;sed&rdquo; commands (a Linux text manipulation tool) to do a few things:</span></p><p class="c2 c7"><span class="c5"></span></p><ol class="c23 lst-kix_b9oyfh079ol-0 start" start="1"><li class="c1 c21 li-bullet-0"><span class="c5">Fix a bug in the pncconf-generated config for an unmatched double quote in the loadrt hm2_eth command.</span></li><li class="c1 c21 li-bullet-0"><span class="c5">Add a USER_COMMAND_FILE to the ini file. This file is later used to customize QtPlasmaC.</span></li><li class="c1 c21 li-bullet-0"><span class="c5">As of LinuxCNC 2.9.2, pncconf does not enable setting the filter of the encoder, so we change the &ldquo;hm2_7i92.0.encoder.00.filter 1&rdquo; command in the main hal file to be &ldquo;hm2_7i92.0.encoder.00.filter 0&rdquo; for reasons described in the capacitive sensor section.</span></li></ol><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span class="c5">This script must be manually run each time after generating the machine configuration via pncconf.</span></p><h3 class="c4" id="h.nggve2ny99g"><span class="c10">Customizing QtPlasmaC preferences</span></h3><p class="c2"><span class="c5">Additionally, there are some QtPlasmaC preferences that are intended to be set interactively. Again in our pursuit of maintaining the ability to regenerate the configuration via pncconf we created a script to automate the customizations we want to be made in the . You can see the details of what is customized including the &ldquo;Arc Voltage Offset&rdquo;, &ldquo;Arc Voltage Scale&rdquo;, &ldquo;Float Switch Travel&rdquo;, &ldquo;Use keyboard shortcuts&rdquo; &ldquo;Ohmic probe enable&rdquo;, and &ldquo;THC enable&rdquo;</span></p><p class="c2"><span>at </span><span class="c0"><a class="c17" href="https://www.google.com/url?q=https://github.com/Sector67/fiber-laser-control/blob/main/config/fix-plasmac-prefs.py&amp;sa=D&amp;source=editors&amp;ust=1715124500162903&amp;usg=AOvVaw0Vat9NIjGFurxWKC9MEJxD">https://github.com/Sector67/fiber-laser-control/blob/main/config/fix-plasmac-prefs.py</a></span><span class="c5">. </span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span class="c5">This script was implemented using the same &ldquo;qtvcp.lib.preferences&rdquo; ini file library that QtPlasmaC uses. This ensures the changes are made in a way that is consistent with QtPlasmaC, and requires that the script is run using python3. This script must also be run after a pncconf-based configuration is written.</span></p><h3 class="c4" id="h.57s6jmv4gmf8"><span class="c10">Customizing QtPlasmaC labels and safe height</span></h3><p class="c2"><span>We additionally wanted to customize a QtPlasmaC label and the safe height. This required using some customization methods that are built into QtPlasmaC. Specifically, if a &ldquo;qtplasmac_custom.py&rdquo; file exists in the configuration directory it is processed. This allows customizing nearly all of the QtPlasmaC Python code. You can see our file at </span><span class="c0"><a class="c17" href="https://www.google.com/url?q=https://github.com/Sector67/fiber-laser-control/blob/main/config/qtplasmac_custom.py&amp;sa=D&amp;source=editors&amp;ust=1715124500163358&amp;usg=AOvVaw0uS83LgiOlpDPTRkRag0Dh">https://github.com/Sector67/fiber-laser-control/blob/main/config/qtplasmac_custom.py</a></span><span class="c5">. As of the writing of this article, we are just changing the &ldquo;Arc&rdquo; label. We may implement more customizations in the future.</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span>We also wanted to be able to set a &ldquo;Safe Height&rdquo; lower than the default limit of 0.75&rdquo;. This was slightly complicated since the default value of the &ldquo;Safe Height&rdquo; was being set after the qtplasmac_custom.py custom Python code is executed. So in order to set a custom Safe Height we need to use another customization method which requires specifying a &ldquo;USER_COMMAND_FILE&rdquo; file in the [DISPLAY] section of the main .ini file. We used &ldquo;USER_COMMAND_FILE = qtplasmac_custom_post.py&rdquo;. In that file we can both set a new custom range for the Safe Height, but &nbsp;. You can see that file at </span><span class="c0"><a class="c17" href="https://www.google.com/url?q=https://github.com/Sector67/fiber-laser-control/blob/main/config/qtplasmac_custom_post.py&amp;sa=D&amp;source=editors&amp;ust=1715124500163715&amp;usg=AOvVaw2oZIYZ6VV2Q99WPEa0uN1T">https://github.com/Sector67/fiber-laser-control/blob/main/config/qtplasmac_custom_post.py</a></span><span class="c5">. </span></p><h3 class="c4" id="h.a722yv5kcs2n"><span class="c10">Capacitive laser height sensing</span></h3><p class="c2"><span>Because the amplifier outputs a variable frequency signal, the output of the amp can be treated as an encoder input with the velocity representing the value of the signal. This makes it conceptually similar to a THCAD Mesa device. We are using a Mesa 5i25 board for high speed I/O, and so we can configure a hostmot2 encoder (</span><span class="c0"><a class="c17" href="https://www.google.com/url?q=http://linuxcnc.org/docs/html/man/man9/hostmot2.9.html%23Encoder&amp;sa=D&amp;source=editors&amp;ust=1715124500163997&amp;usg=AOvVaw05fYcSmhf1yCl2W007OW-e">linuxcnc.org/docs/html/man/man9/hostmot2.9.html#Encoder</a></span><span class="c5">) via pncconf to read the amp output. Since we are only reading a pulse train and not a quadrature encoder this encoder needs to be in &ldquo;counter-mode&rdquo; so that each rising edge of the phase-A input is counted, and the value on phase-B is ignored. </span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span class="c5">The relatively high frequencies output from the sensor (up to ~3MHz) create some special considerations for interfacing. The Mesa card&rsquo;s FPGA is fast enough to read the signal, but for the fastest signals of the amps, the &ldquo;filter&rdquo; setting of the hostmot2 encoder should be set to &ldquo;False&rdquo; since 15 sample clocks at 25MHz is too long to successfully sample a ~3MHz signal. The filter documentation states:</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c1"><span class="c5">(bit r/w) filter</span></p><p class="c1 c7"><span class="c5"></span></p><p class="c1"><span class="c5">If set to True (the default), the quadrature counter needs 15 sample clocks to register a change on any of the three input lines (any pulse shorter than this is rejected as noise). If set to False, the quadrature counter needs only 3 clocks to register a change. The default encoder sample clock runs at approximately 25 to 33 MHz but can be changed globally with the sample-frequency or muxed-sample-frequency pin.</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span class="c5">The non-default (filter = false) 3 clocks should be fast enough, and with the schmitt trigger the signal is clean enough to work well with a three clock transition. Your custom.hal file will need something like the following:</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c1"><span class="c5">setp &nbsp; &nbsp;hm2_5i25.0.encoder.00.counter-mode 1</span></p><p class="c1"><span class="c5">setp &nbsp; &nbsp;hm2_5i25.0.encoder.00.filter 0</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span>You can see ours at </span><span class="c0"><a class="c17" href="https://www.google.com/url?q=https://github.com/Sector67/fiber-laser-control/blob/main/config/custom.hal&amp;sa=D&amp;source=editors&amp;ust=1715124500164776&amp;usg=AOvVaw0HQ9RlY9WLUij8Pohw-X7c">https://github.com/Sector67/fiber-laser-control/blob/main/config/custom.hal</a></span><span>. With this configuration in place, you can use Halscope or Halmeter to see the &ldquo;velocity&rdquo; response of the encoder change with the distance to the metal. The effective response range </span><span>is around 0.5 inches</span><span class="c5">, with good feedback in the first 0.1 inches off the material.</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span class="c5">The output of the encoder velocity from a 0.1&rdquo; Z move can be seen below:</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 376.00px;"><img alt="" src="images/image1.png" style="width: 624.00px; height: 376.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c2"><span class="c6">A halscope image of the position and capacitive sensor input</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span class="c5">We&rsquo;ve scaled this value using a combination of the encoder scale and &ldquo;Arc Voltage Offset&rdquo; and &ldquo;Arc Voltage Scale&rdquo; PLASMA_PARAMETERS. You can see the specific changes in the earlier section on customizing the configuration, but by default the QtPlasmaC GUI does not allow voltage offsets higher than 5 digits, so we use the encoder scale to get the values into a range that can be scaled using PLASMA_PARAMETERS. This could be changed using the qtplasmac_custom_post.py method that we used to change Safe Height, but we already had this workaround in place prior to figuring out how to customize the Safe Height range.</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span class="c5">This results in a ~50-100 range for &quot;arc voltage&quot; in the QtPlasmaC GUI and is sensitive enough to hold height well for the cuts that we do. We do customize the GUI to change &ldquo;Arc&rdquo; to &ldquo;CAPACITIVE TORCH HEIGHT&rdquo; via the qtplasmac_custom.py file. </span></p><h3 class="c4" id="h.uu90zu2vk0y5"><span class="c10">Fake ohmic probe and arc ok</span></h3><p class="c2"><span class="c5">Since the capacitive sensor output changes dramatically when it touches the part, we were able to implement a synthetic &ldquo;ohmic probe&rdquo; using custom hal:</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c1"><span class="c5"># Make a fake Ohmic probe based on the capacitive sensor</span></p><p class="c1"><span class="c5"># Use the .velocity-rpm so the .velocity can be left unused for arc_ok</span></p><p class="c1"><span class="c5">loadrt comp count=1</span></p><p class="c1"><span class="c5">addf comp.0 servo-thread</span></p><p class="c1"><span class="c5">net fake-ohmic-probe-in hm2_7i92.0.encoder.00.velocity-rpm comp.0.in0</span></p><p class="c1"><span class="c5">setp comp.0.in1 930000.0</span></p><p class="c1"><span class="c5">net plasmac:ohmic-probe comp.0.out</span></p><p class="c1"><span class="c5"># ohmic output is comp.0.out</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span class="c5">We also implemented an &ldquo;always on&rdquo; arc ok signal:</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c1"><span class="c5"># Fake &quot;Arc OK&quot; signal that is always true</span></p><p class="c1"><span class="c5">loadrt not count=1</span></p><p class="c1"><span class="c5">addf not.0 servo-thread</span></p><p class="c1"><span class="c5">setp not.0.in FALSE</span></p><p class="c1"><span class="c5">net plasmac:arc-ok-in not.0.out</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span class="c5">You can see the full configuration in context at https://github.com/Sector67/fiber-laser-control/blob/main/config/custom.hal.</span></p><h3 class="c4" id="h.vvnyaulu6bwp"><span class="c10">Controlling laser power</span></h3><p class="c2"><span class="c5">The hardware board that converts PWM to 0-10VDC was interfaced to LinuxCNC with the following added to the custom.hal file:</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c1"><span class="c5"># enable the spindle PWM to drive the laser power</span></p><p class="c1"><span class="c5">net plasmac:torch-on hm2_7i92.0.pwmgen.00.enable </span></p><p class="c1"><span class="c5">setp hm2_7i92.0.pwmgen.00.scale 100</span></p><p class="c1"><span class="c5">net laser-power spindle.0.speed-out-abs hm2_7i92.0.pwmgen.00.value</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span>You can see the full file at </span><span class="c0"><a class="c17" href="https://www.google.com/url?q=https://github.com/Sector67/fiber-laser-control/blob/main/config/custom.hal&amp;sa=D&amp;source=editors&amp;ust=1715124500166963&amp;usg=AOvVaw2hof6PgMbTohHHhLz5aRrX">https://github.com/Sector67/fiber-laser-control/blob/main/config/custom.hal</a></span><span class="c5">. </span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span class="c5">Additionally, the PWM frequency was configured to be 2000Hz via pncconf and you can see that value reflected in the laser_cutter.hal file:</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c1"><span class="c5">setp &nbsp; &nbsp;hm2_7i92.0.pwmgen.pwm_frequency 2000</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span>Together these enable a 0-10VDC laser power signal. This will work well for cutting where we are not changing the power frequently. If we want to do raster-style engraving we&rsquo;d need to switch to using something that does not pause motion when changed. To do that we&rsquo;d need to switch to using something like M67 as outlined by tommylight at </span><span class="c0"><a class="c17" href="https://www.google.com/url?q=https://forum.linuxcnc.org/plasma-laser/51727-best-way-to-control-laser-power-with-qtplasmac&amp;sa=D&amp;source=editors&amp;ust=1715124500167481&amp;usg=AOvVaw3kcCvBhAxxy1qEbqGaDuqV">https://forum.linuxcnc.org/plasma-laser/51727-best-way-to-control-laser-power-with-qtplasmac</a></span><span class="c5">. </span></p><h3 class="c4" id="h.tt0nlt5jteuy"><span class="c10">GCode laser power injection</span></h3><p class="c2"><span class="c5">Since we are controlling laser power with spindle speed 0-100 and using the materials &ldquo;cut amps&rdquo; to specify the power level for that material, we also need to modify each &ldquo;M3 $0 S1&rdquo; line to utilize the material&rsquo;s cut_amps. The line needs to end up looking like</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c1"><span>M03 $0 S#&lt;_hal[qtplasmac.cut_amps-s]&gt;</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span>We achieved this by creating a custom_filter.py that you can see at </span><span class="c0"><a class="c17" href="https://www.google.com/url?q=https://github.com/Sector67/fiber-laser-control/blob/main/config/custom_filter.py&amp;sa=D&amp;source=editors&amp;ust=1715124500167986&amp;usg=AOvVaw1g1M46W4PSFSVweRfWnUln">https://github.com/Sector67/fiber-laser-control/blob/main/config/custom_filter.py</a></span><span class="c5">. This has generally worked OK for us so far but might need some refinement as we use different post processors.</span></p><h3 class="c4" id="h.3ajn6l2pqa62"><span class="c10">Controlling the light tree</span></h3><p class="c2"><span class="c5">The green light of the light tree is simply wired to the +24VDC supply and indicates the machine is powered.</span></p><p class="c2"><span class="c5">The orange light is intended to indicate that the laser could fire at any time. It is controlled by the following custom hal:</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c1"><span class="c5"># enable the orange light to represent when the machine is enabled</span></p><p class="c1"><span class="c5"># and the &quot;torch on&quot; is enabled.</span></p><p class="c1"><span class="c5">net plasmac:torch-enable and2.0.in0</span></p><p class="c1"><span class="c5">net machine-is-on and2.0.in1</span></p><p class="c1"><span class="c5">net orange-light and2.0.out</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span class="c5">We sometimes run a program without the torch on to test things, and so it is convenient to see at a glance that the laser will not fire even if the program is started.</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span class="c5">The red light indicates that a program is running. If the orange and red lights are both lit then laser may fire at any time. The red light is controlled by the following custom hal:</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c1"><span class="c5">net plasmac:program-is-running and2.1.in0</span></p><p class="c1"><span class="c5">net halui-mode-is-auto and2.1.in1</span></p><p class="c1"><span class="c5">net program-running and2.1.out</span></p><p class="c1 c7"><span class="c5"></span></p><p class="c1"><span class="c5">net program-running or2.1.in0</span></p><p class="c1"><span class="c5">net plasmac:program-is-paused or2.1.in1</span></p><p class="c1"><span class="c5">net program-running-or-paused or2.1.out</span></p><p class="c1 c7"><span class="c5"></span></p><p class="c1"><span class="c5">&hellip;</span></p><p class="c1 c7"><span class="c5"></span></p><p class="c1"><span class="c5"># enable the red light to represent when the laser is &quot;firing&quot;</span></p><p class="c1"><span class="c5"># currently defined as when a program is running or the torch is firing</span></p><p class="c1 c7"><span class="c5"></span></p><p class="c1"><span class="c5">net program-running-or-paused or2.0.in1</span></p><p class="c1"><span class="c5">net plasmac:torch-on or2.0.in0</span></p><p class="c1"><span class="c5">net red-light or2.0.out</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span>You can see the full custom.hal file at </span><span class="c0"><a class="c17" href="https://www.google.com/url?q=https://github.com/Sector67/fiber-laser-control/blob/main/config/custom.hal&amp;sa=D&amp;source=editors&amp;ust=1715124500169565&amp;usg=AOvVaw2sJWw8Hp1_G_e6qX3edA1U">https://github.com/Sector67/fiber-laser-control/blob/main/config/custom.hal</a></span><span class="c5">. </span></p><h3 class="c4" id="h.oexia2hci5ym"><span class="c10">Gas assist</span></h3><p class="c2"><span class="c5">We are currently using compressed air exclusively, and have implemented a solenoid valve to turn on when a program is running and turn off shortly after. The gas assist is controlled by the following custom hal:</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c1"><span class="c5">net plasmac:program-is-running and2.1.in0</span></p><p class="c1"><span class="c5">net halui-mode-is-auto and2.1.in1</span></p><p class="c1"><span class="c5">net program-running and2.1.out</span></p><p class="c1 c7"><span class="c5"></span></p><p class="c1"><span class="c5">&hellip;</span></p><p class="c1 c7"><span class="c5"></span></p><p class="c1"><span class="c5"># for now a very naive gas-solenoid control</span></p><p class="c1"><span class="c5">loadrt timedelay</span></p><p class="c1"><span class="c5">addf timedelay.0 servo-thread</span></p><p class="c1"><span class="c5">net program-running timedelay.0.in</span></p><p class="c1"><span class="c5">setp timedelay.0.on-delay 0.0</span></p><p class="c1"><span class="c5">setp timedelay.0.off-delay 1.0</span></p><p class="c1"><span class="c5">net gas-solenoid timedelay.0.out</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span class="c5">The gas uses the timedelay component to run for a second after the program ends. This is probably not needed but we&rsquo;ve left it in place. This timing seems to work well enough as the initial probe takes more than enough time for the gas to get started. If we wanted to turn the torch on and off during a program, we could potentially modify the &ldquo;arc ok&rdquo; signal to wait a second for gas to flow before turning the laser on. This would slow things down a bit but if we ever used a gas other than compressed air we may want to conserve it.</span></p><h3 class="c4" id="h.7bulkggbz790"><span class="c10">The cameras</span></h3><p class="c2"><span class="c5">We wanted to set up a couple of USB cameras to watch the whole table and the laser head itself. We used a cheap endoscope camera for the laser head. We were using a pretty old PC and ran into USB throughput issues, but were able to get small videos for both cameras with the following scripts:</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c1"><span class="c5">ffplay -i /dev/video0 -x 320 -y 240 -an -window_title &quot;lens camera&quot; -left 1400 -top 100 -video_size 320x240</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span class="c5">and</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c1"><span class="c5">ffplay -i /dev/video2 -x 320 -y 240 -an -window_title &quot;machine camera&quot; -left 1400 -top 400 -video_size 320x240</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span class="c5">If you have a more modern PC you could probably run larger video streams. We were then able to run the Linux &ldquo;SimpleScreenRecorder&rdquo; tool to capture videos of the whole screen including video streams. </span></p><h2 class="c18" id="h.beqp5g73ad97"><span class="c13">Results and next steps</span></h2><p class="c2"><span class="c5">With this configuration in place we&rsquo;ve made basic cuts in stainless and mild steel. We still have a bunch of experimentation and tuning to do. The machine cuts 1mm stainless sheet very well, leaving a small burr around the part. We&rsquo;ve cut up to 0.1&rdquo; mild still and expect to be able to cut at least 0.125&rdquo; with this setup. Our table could be more rigid, so we do currently get some resonance.</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2"><span>You can see one of our very first videos at: </span><span class="c0"><a class="c17" href="https://www.google.com/url?q=https://www.youtube.com/watch?v%3DyS2oHtm_X6E&amp;sa=D&amp;source=editors&amp;ust=1715124500171268&amp;usg=AOvVaw1QmK62Nzncrze_bNc1hG6e">https://www.youtube.com/watch?v=yS2oHtm_X6E</a></span><span>, and a</span><span>nother video of the laser cutting 1mm stainless steel: </span><span class="c0"><a class="c17" href="https://www.google.com/url?q=https://www.youtube.com/watch?v%3DHZwUm9RlLvU&amp;sa=D&amp;source=editors&amp;ust=1715124500171390&amp;usg=AOvVaw3Vt65ucxpkpOZ21R3ldfcT">https://www.youtube.com/watch?v=HZwUm9RlLvU</a></span><span class="c5">.</span></p><p class="c2 c7"><span class="c5"></span></p><p class="c2 c7"><span class="c5"></span></p></body></html>